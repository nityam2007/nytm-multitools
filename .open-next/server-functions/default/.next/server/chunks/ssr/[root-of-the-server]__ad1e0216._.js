module.exports=[2157,(a,b,c)=>{b.exports=a.x("node:fs",()=>require("node:fs"))},1457,(a,b,c)=>{b.exports=a.x("node:readline",()=>require("node:readline"))},44445,a=>{"use strict";let b,c,d,e,f;var g,h=a.i(37936),i=a.i(5246),j=a.i(14747);function k(a){return a.replace(/^[A-Z]:/,"").replace(/\\/g,"/")}let l=a=>void 0===a?void 0:a.variant??a.enabled,m=a=>{if("string"!=typeof a)return a;try{return JSON.parse(a)}catch{return a}},n="0123456789abcdef";class o{constructor(a){this.bytes=a}static ofInner(a){if(16===a.length)return new o(a);throw TypeError("not 128-bit length")}static fromFieldsV7(a,b,c,d){if(!Number.isInteger(a)||!Number.isInteger(b)||!Number.isInteger(c)||!Number.isInteger(d)||a<0||b<0||c<0||d<0||a>0xffffffffffff||b>4095||c>0x3fffffff||d>0xffffffff)throw RangeError("invalid field value");let e=new Uint8Array(16);return e[0]=a/0x10000000000,e[1]=a/0x100000000,e[2]=a/0x1000000,e[3]=a/65536,e[4]=a/256,e[5]=a,e[6]=112|b>>>8,e[7]=b,e[8]=128|c>>>24,e[9]=c>>>16,e[10]=c>>>8,e[11]=c,e[12]=d>>>24,e[13]=d>>>16,e[14]=d>>>8,e[15]=d,new o(e)}static parse(a){let b;switch(a.length){case 32:b=/^[0-9a-f]{32}$/i.exec(a)?.[0];break;case 36:b=/^([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(a)?.slice(1,6).join("");break;case 38:b=/^\{([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})\}$/i.exec(a)?.slice(1,6).join("");break;case 45:b=/^urn:uuid:([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})$/i.exec(a)?.slice(1,6).join("")}if(b){let a=new Uint8Array(16);for(let c=0;c<16;c+=4){let d=parseInt(b.substring(2*c,2*c+8),16);a[c+0]=d>>>24,a[c+1]=d>>>16,a[c+2]=d>>>8,a[c+3]=d}return new o(a)}throw SyntaxError("could not parse UUID string")}toString(){let a="";for(let b=0;b<this.bytes.length;b++)a+=n.charAt(this.bytes[b]>>>4),a+=n.charAt(15&this.bytes[b]),(3===b||5===b||7===b||9===b)&&(a+="-");return a}toHex(){let a="";for(let b=0;b<this.bytes.length;b++)a+=n.charAt(this.bytes[b]>>>4),a+=n.charAt(15&this.bytes[b]);return a}toJSON(){return this.toString()}getVariant(){let a=this.bytes[8]>>>4;if(a<0)throw Error("unreachable");if(a<=7)return this.bytes.every(a=>0===a)?"NIL":"VAR_0";if(a<=11)return"VAR_10";if(a<=13)return"VAR_110";if(a<=15)return this.bytes.every(a=>255===a)?"MAX":"VAR_RESERVED";throw Error("unreachable")}getVersion(){return"VAR_10"===this.getVariant()?this.bytes[6]>>>4:void 0}clone(){return new o(this.bytes.slice(0))}equals(a){return 0===this.compareTo(a)}compareTo(a){for(let b=0;b<16;b++){let c=this.bytes[b]-a.bytes[b];if(0!==c)return Math.sign(c)}return 0}}class p{constructor(a){this.timestamp=0,this.counter=0,this.random=a??q()}generate(){return this.generateOrResetCore(Date.now(),1e4)}generateOrAbort(){return this.generateOrAbortCore(Date.now(),1e4)}generateOrResetCore(a,b){let c=this.generateOrAbortCore(a,b);return void 0===c&&(this.timestamp=0,c=this.generateOrAbortCore(a,b)),c}generateOrAbortCore(a,b){if(!Number.isInteger(a)||a<1||a>0xffffffffffff)throw RangeError("`unixTsMs` must be a 48-bit positive integer");if(b<0||b>0xffffffffffff)throw RangeError("`rollbackAllowance` out of reasonable range");if(a>this.timestamp)this.timestamp=a,this.resetCounter();else{if(!(a+b>=this.timestamp))return;this.counter++,this.counter>0x3ffffffffff&&(this.timestamp++,this.resetCounter())}return o.fromFieldsV7(this.timestamp,Math.trunc(this.counter/0x40000000),this.counter&0x40000000-1,this.random.nextUint32())}resetCounter(){this.counter=1024*this.random.nextUint32()+(1023&this.random.nextUint32())}generateV4(){let a=new Uint8Array(Uint32Array.of(this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32(),this.random.nextUint32()).buffer);return a[6]=64|a[6]>>>4,a[8]=128|a[8]>>>2,o.ofInner(a)}}let q=()=>({nextUint32:()=>65536*Math.trunc(65536*Math.random())+Math.trunc(65536*Math.random())}),r=()=>(b||(b=new p)).generate(),s=["amazonbot","amazonproductbot","app.hypefactors.com","applebot","archive.org_bot","awariobot","backlinksextendedbot","baiduspider","bingbot","bingpreview","chrome-lighthouse","dataforseobot","deepscan","duckduckbot","facebookexternal","facebookcatalog","http://yandex.com/bots","hubspot","ia_archiver","leikibot","linkedinbot","meta-externalagent","mj12bot","msnbot","nessus","petalbot","pinterest","prerender","rogerbot","screaming frog","sebot-wa","sitebulb","slackbot","slurp","trendictionbot","turnitin","twitterbot","vercel-screenshot","vercelbot","yahoo! slurp","yandexbot","zoombot","bot.htm","bot.php","(bot;","bot/","crawler","ahrefsbot","ahrefssiteaudit","semrushbot","siteauditbot","splitsignalbot","gptbot","oai-searchbot","chatgpt-user","perplexitybot","better uptime bot","sentryuptimebot","uptimerobot","headlesschrome","cypress","google-hoteladsverifier","adsbot-google","apis-google","duplexweb-google","feedfetcher-google","google favicon","google web preview","google-read-aloud","googlebot","googleother","google-cloudvertexbot","googleweblight","mediapartners-google","storebot-google","google-inspectiontool","bytespider"],t=function(a,b=[]){if(!a)return!1;let c=a.toLowerCase();return s.concat(b).some(a=>{let b=a.toLowerCase();return -1!==c.indexOf(b)})};a.s(["DEFAULT_BLOCKED_UA_STRS",()=>s,"isBlockedUA",()=>t],19673);var u=((g={}).AnonymousId="anonymous_id",g.DistinctId="distinct_id",g.Props="props",g.FeatureFlagDetails="feature_flag_details",g.FeatureFlags="feature_flags",g.FeatureFlagPayloads="feature_flag_payloads",g.BootstrapFeatureFlagDetails="bootstrap_feature_flag_details",g.BootstrapFeatureFlags="bootstrap_feature_flags",g.BootstrapFeatureFlagPayloads="bootstrap_feature_flag_payloads",g.OverrideFeatureFlags="override_feature_flags",g.Queue="queue",g.OptedOut="opted_out",g.SessionId="session_id",g.SessionStartTimestamp="session_start_timestamp",g.SessionLastTimestamp="session_timestamp",g.PersonProperties="person_properties",g.GroupProperties="group_properties",g.InstalledAppBuild="installed_app_build",g.InstalledAppVersion="installed_app_version",g.SessionReplay="session_replay",g.SurveyLastSeenDate="survey_last_seen_date",g.SurveysSeen="surveys_seen",g.Surveys="surveys",g.RemoteConfig="remote_config",g.FlagsEndpointWasHit="flags_endpoint_was_hit",g);let v=["$snapshot","$pageview","$pageleave","$set","survey dismissed","survey sent","survey shown","$identify","$groupidentify","$create_alias","$$client_ingestion_warning","$web_experiment_applied","$feature_enrollment_update","$feature_flag_called"];function w(a,b){return -1!==a.indexOf(b)}let x=function(a){return a.trim()},y=function(a){return a.replace(/^\$/,"")};function z(a){return["distinct_id","distinctid"].includes(a.toLowerCase())}a.s(["includes",()=>w,"isDistinctIdStringLike",()=>z,"stripLeadingDollar",()=>y,"trim",()=>x],85314);let A=Array.isArray,B=Object.prototype,C=B.hasOwnProperty,D=B.toString,E=A||function(a){return"[object Array]"===D.call(a)},F=a=>"function"==typeof a,G=a=>F(a)&&-1!==a.toString().indexOf("[native code]"),H=a=>a===Object(a)&&!E(a),I=a=>{if(H(a)){for(let b in a)if(C.call(a,b))return!1;return!0}return!1},J=a=>void 0===a,K=a=>"[object String]"==D.call(a),L=a=>K(a)&&0===a.trim().length,M=a=>null===a,N=a=>J(a)||M(a),O=a=>"[object Number]"==D.call(a),P=a=>"[object Boolean]"===D.call(a),Q=a=>a instanceof FormData,R=a=>a instanceof File,S=a=>a instanceof Error,T=a=>w(v,a);function U(a,b){try{return a instanceof b}catch{return!1}}function V(a){return null===a||"object"!=typeof a}function W(a,b){return Object.prototype.toString.call(a)===`[object ${b}]`}function X(a){switch(Object.prototype.toString.call(a)){case"[object Error]":case"[object Exception]":case"[object DOMException]":case"[object DOMError]":case"[object WebAssembly.Exception]":return!0;default:return U(a,Error)}}function Y(a){return W(a,"ErrorEvent")}function Z(a){return!J(Event)&&U(a,Event)}function $(a){return W(a,"Object")}let _=[!0,"true",1,"1","yes"],aa=a=>w(_,a),ab=[!1,"false",0,"0","no"],ac=a=>w(ab,a);function ad(a,b,c,d,e){if(b>c&&(d.warn("min cannot be greater than max."),b=c),O(a))if(a>c)return d.warn(" cannot be  greater than max: "+c+". Using max value instead."),c;else return a<b?(d.warn(" cannot be less than min: "+b+". Using min value instead."),b):a;return d.warn(" must be a number. using max or fallback. max: "+c+", fallback: "+e),ad(e||c,b,c,d)}a.s(["hasOwnProperty",()=>C,"isArray",()=>E,"isBoolean",()=>P,"isBuiltin",()=>W,"isEmptyObject",()=>I,"isEmptyString",()=>L,"isError",()=>X,"isErrorEvent",()=>Y,"isEvent",()=>Z,"isFile",()=>R,"isFormData",()=>Q,"isFunction",()=>F,"isInstanceOf",()=>U,"isKnownUnsafeEditableEvent",()=>T,"isNativeFunction",()=>G,"isNoLike",()=>ac,"isNull",()=>M,"isNullish",()=>N,"isNumber",()=>O,"isObject",()=>H,"isPlainError",()=>S,"isPlainObject",()=>$,"isPrimitive",()=>V,"isString",()=>K,"isUndefined",()=>J,"isYesLike",()=>aa,"noLikeValues",()=>ab,"yesLikeValues",()=>_],73117),a.s(["clampToRange",()=>ad],18238);class ae{constructor(a){this._buckets={},this._onBucketRateLimited=a._onBucketRateLimited,this._bucketSize=ad(a.bucketSize,0,100,a._logger),this._refillRate=ad(a.refillRate,0,this._bucketSize,a._logger),this._refillInterval=ad(a.refillInterval,0,864e5,a._logger)}_applyRefill(a,b){let c=Math.floor((b-a.lastAccess)/this._refillInterval);if(c>0){let b=c*this._refillRate;a.tokens=Math.min(a.tokens+b,this._bucketSize),a.lastAccess=a.lastAccess+c*this._refillInterval}}consumeRateLimit(a){let b=Date.now(),c=String(a),d=this._buckets[c];return d?this._applyRefill(d,b):(d={tokens:this._bucketSize,lastAccess:b},this._buckets[c]=d),0===d.tokens||(d.tokens--,0===d.tokens&&this._onBucketRateLimited?.(a),0===d.tokens)}stop(){this._buckets={}}}a.s(["BucketedRateLimiter",()=>ae],48301);class af{add(a){let b=r().toString();return this.promiseByIds[b]=a,a.catch(()=>{}).finally(()=>{delete this.promiseByIds[b]}),a}async join(){let a=Object.values(this.promiseByIds),b=a.length;for(;b>0;)await Promise.all(a),b=(a=Object.values(this.promiseByIds)).length}get length(){return Object.keys(this.promiseByIds).length}constructor(){this.promiseByIds={}}}a.s(["PromiseQueue",()=>af],20981);let ag=(a,b,c)=>{function d(e,...f){b(()=>{(0,c[e])(a,...f)})}return{info:(...a)=>{d("log",...a)},warn:(...a)=>{d("warn",...a)},error:(...a)=>{d("error",...a)},critical:(...b)=>{c.error(a,...b)},createLogger:d=>ag(`${a} ${d}`,b,c)}},ah=a=>a();function ai(a,b=ah){return ag(a,b,function(a=console){return{log:a.log.bind(a),warn:a.warn.bind(a),error:a.error.bind(a),debug:a.debug.bind(a)}}())}a.s(["_createLogger",()=>ag,"createLogger",()=>ai],99410);let aj="utf8";function ak(a,b){if(!a||"string"!=typeof a||0===a.trim().length)throw Error(b)}function al(a){return a?.replace(/\/+$/,"")}async function am(a,b){let c=null;for(let d=0;d<b.retryCount+1;d++){d>0&&await new Promise(a=>setTimeout(a,b.retryDelay));try{return await a()}catch(a){if(c=a,!b.retryCheck(a))throw a}}throw c}function an(){return new Date().getTime()}function ao(){return new Date().toISOString()}function ap(a,b){let c=setTimeout(a,b);return c?.unref&&c?.unref(),c}let aq=a=>a&&"function"==typeof a.then,ar=a=>a instanceof Error;function as(){return"undefined"!=typeof fetch?fetch:void 0!==globalThis.fetch?globalThis.fetch:void 0}function at(a){return Promise.all(a.map(a=>(a??Promise.resolve()).then(a=>({status:"fulfilled",value:a}),a=>({status:"rejected",reason:a}))))}a.s(["STRING_FORMAT",()=>aj,"allSettled",()=>at,"assert",()=>ak,"currentISOTime",()=>ao,"currentTimestamp",()=>an,"getFetch",()=>as,"isError",()=>ar,"isPromise",()=>aq,"removeTrailingSlash",()=>al,"retriable",()=>am,"safeSetTimeout",()=>ap],38785);class au{constructor(){this.events={},this.events={}}on(a,b){return this.events[a]||(this.events[a]=[]),this.events[a].push(b),()=>{this.events[a]=this.events[a].filter(a=>a!==b)}}emit(a,b){for(let c of this.events[a]||[])c(b);for(let c of this.events["*"]||[])c(a,b)}}async function av(a,b=!0){try{let b=new Blob([a],{type:"text/plain"}).stream().pipeThrough(new CompressionStream("gzip"));return await new Response(b).blob()}catch(a){return b&&console.error("Failed to gzip compress data",a),null}}class aw extends Error{constructor(a,b){super("HTTP error while fetching PostHog: status="+a.status+", reqByteLength="+b),this.response=a,this.reqByteLength=b,this.name="PostHogFetchHttpError"}get status(){return this.response.status}get text(){return this.response.text()}get json(){return this.response.json()}}class ax extends Error{constructor(a){super("Network error while fetching PostHog",a instanceof Error?{cause:a}:{}),this.error=a,this.name="PostHogFetchNetworkError"}}async function ay(a){if(a instanceof aw){let b="";try{b=await a.text}catch{}console.error(`Error while flushing PostHog: message=${a.message}, response body=${b}`,a)}else console.error("Error while flushing PostHog",a);return Promise.resolve()}function az(a){return"object"==typeof a&&(a instanceof aw||a instanceof ax)}function aA(a){return"object"==typeof a&&a instanceof aw&&413===a.status}class aB{constructor(a,b={}){this.flushPromise=null,this.shutdownPromise=null,this.promiseQueue=new af,this._events=new au,this._isInitialized=!1,ak(a,"You must pass your PostHog project's api key."),this.apiKey=a,this.host=al(b.host||"https://us.i.posthog.com"),this.flushAt=b.flushAt?Math.max(b.flushAt,1):20,this.maxBatchSize=Math.max(this.flushAt,b.maxBatchSize??100),this.maxQueueSize=Math.max(this.flushAt,b.maxQueueSize??1e3),this.flushInterval=b.flushInterval??1e4,this.preloadFeatureFlags=b.preloadFeatureFlags??!0,this.defaultOptIn=b.defaultOptIn??!0,this.disableSurveys=b.disableSurveys??!1,this._retryOptions={retryCount:b.fetchRetryCount??3,retryDelay:b.fetchRetryDelay??3e3,retryCheck:az},this.requestTimeout=b.requestTimeout??1e4,this.featureFlagsRequestTimeoutMs=b.featureFlagsRequestTimeoutMs??3e3,this.remoteConfigRequestTimeoutMs=b.remoteConfigRequestTimeoutMs??3e3,this.disableGeoip=b.disableGeoip??!0,this.disabled=b.disabled??!1,this.historicalMigration=b?.historicalMigration??!1,this.evaluationEnvironments=b?.evaluationEnvironments,this._initPromise=Promise.resolve(),this._isInitialized=!0,this._logger=ai("[PostHog]",this.logMsgIfDebug.bind(this)),this.disableCompression=!("CompressionStream"in globalThis)||(b?.disableCompression??!1)}logMsgIfDebug(a){this.isDebug&&a()}wrap(a){return this.disabled?void this._logger.warn("The client is disabled"):this._isInitialized?a():void this._initPromise.then(()=>a())}getCommonEventProperties(){return{$lib:this.getLibraryId(),$lib_version:this.getLibraryVersion()}}get optedOut(){return this.getPersistedProperty(u.OptedOut)??!this.defaultOptIn}async optIn(){this.wrap(()=>{this.setPersistedProperty(u.OptedOut,!1)})}async optOut(){this.wrap(()=>{this.setPersistedProperty(u.OptedOut,!0)})}on(a,b){return this._events.on(a,b)}debug(a=!0){if(this.removeDebugCallback?.(),a){let a=this.on("*",(a,b)=>this._logger.info(a,b));this.removeDebugCallback=()=>{a(),this.removeDebugCallback=void 0}}}get isDebug(){return!!this.removeDebugCallback}get isDisabled(){return this.disabled}buildPayload(a){return{distinct_id:a.distinct_id,event:a.event,properties:{...a.properties||{},...this.getCommonEventProperties()}}}addPendingPromise(a){return this.promiseQueue.add(a)}identifyStateless(a,b,c){this.wrap(()=>{let d={...this.buildPayload({distinct_id:a,event:"$identify",properties:b})};this.enqueue("identify",d,c)})}async identifyStatelessImmediate(a,b,c){let d={...this.buildPayload({distinct_id:a,event:"$identify",properties:b})};await this.sendImmediate("identify",d,c)}captureStateless(a,b,c,d){this.wrap(()=>{let e=this.buildPayload({distinct_id:a,event:b,properties:c});this.enqueue("capture",e,d)})}async captureStatelessImmediate(a,b,c,d){let e=this.buildPayload({distinct_id:a,event:b,properties:c});await this.sendImmediate("capture",e,d)}aliasStateless(a,b,c,d){this.wrap(()=>{let e=this.buildPayload({event:"$create_alias",distinct_id:b,properties:{...c||{},distinct_id:b,alias:a}});this.enqueue("alias",e,d)})}async aliasStatelessImmediate(a,b,c,d){let e=this.buildPayload({event:"$create_alias",distinct_id:b,properties:{...c||{},distinct_id:b,alias:a}});await this.sendImmediate("alias",e,d)}groupIdentifyStateless(a,b,c,d,e,f){this.wrap(()=>{let g=this.buildPayload({distinct_id:e||`$${a}_${b}`,event:"$groupidentify",properties:{$group_type:a,$group_key:b,$group_set:c||{},...f||{}}});this.enqueue("capture",g,d)})}async getRemoteConfig(){await this._initPromise;let a=this.host;"https://us.i.posthog.com"===a?a="https://us-assets.i.posthog.com":"https://eu.i.posthog.com"===a&&(a="https://eu-assets.i.posthog.com");let b=`${a}/array/${this.apiKey}/config`,c={method:"GET",headers:{...this.getCustomHeaders(),"Content-Type":"application/json"}};return this.fetchWithRetry(b,c,{retryCount:0},this.remoteConfigRequestTimeoutMs).then(a=>a.json()).catch(a=>{this._logger.error("Remote config could not be loaded",a),this._events.emit("error",a)})}async getFlags(a,b={},c={},d={},e={},f=!0){await this._initPromise;let g=`${this.host}/flags/?v=2${f?"&config=true":""}`,h={token:this.apiKey,distinct_id:a,groups:b,person_properties:c,group_properties:d,...e};this.evaluationEnvironments&&this.evaluationEnvironments.length>0&&(h.evaluation_environments=this.evaluationEnvironments);let i={method:"POST",headers:{...this.getCustomHeaders(),"Content-Type":"application/json"},body:JSON.stringify(h)};return this._logger.info("Flags URL",g),this.fetchWithRetry(g,i,{retryCount:0},this.featureFlagsRequestTimeoutMs).then(a=>a.json()).then(a=>(a=>{if("flags"in a){let b,c=Object.fromEntries(Object.entries(a.flags??{}).map(([a,b])=>[a,l(b)]).filter(([,a])=>void 0!==a)),d=Object.fromEntries(Object.keys(b=a.flags??{}).filter(a=>{let c=b[a];return c.enabled&&c.metadata&&void 0!==c.metadata.payload}).map(a=>{let c=b[a].metadata?.payload;return[a,c?m(c):void 0]}));return{...a,featureFlags:c,featureFlagPayloads:d}}{let b=a.featureFlags??{},c=Object.fromEntries(Object.entries(a.featureFlagPayloads||{}).map(([a,b])=>[a,m(b)])),d=Object.fromEntries(Object.entries(b).map(([a,b])=>{var d,e;return[a,{key:a,enabled:"string"==typeof(d=b)||d,variant:"string"==typeof d?d:void 0,reason:void 0,metadata:{id:void 0,version:void 0,payload:(e=c[a])?JSON.stringify(e):void 0,description:void 0}}]}));return{...a,featureFlags:b,featureFlagPayloads:c,flags:d}}})(a)).catch(a=>{this._events.emit("error",a)})}async getFeatureFlagStateless(a,b,c={},d={},e={},f){await this._initPromise;let g=await this.getFeatureFlagDetailStateless(a,b,c,d,e,f);if(void 0===g)return{response:void 0,requestId:void 0};let h=l(g.response);return void 0===h&&(h=!1),{response:h,requestId:g.requestId}}async getFeatureFlagDetailStateless(a,b,c={},d={},e={},f){await this._initPromise;let g=await this.getFeatureFlagDetailsStateless(b,c,d,e,f,[a]);if(void 0!==g)return{response:g.flags[a],requestId:g.requestId}}async getFeatureFlagPayloadStateless(a,b,c={},d={},e={},f){await this._initPromise;let g=await this.getFeatureFlagPayloadsStateless(b,c,d,e,f,[a]);if(!g)return;let h=g[a];return void 0===h?null:h}async getFeatureFlagPayloadsStateless(a,b={},c={},d={},e,f){return await this._initPromise,(await this.getFeatureFlagsAndPayloadsStateless(a,b,c,d,e,f)).payloads}async getFeatureFlagsStateless(a,b={},c={},d={},e,f){return await this._initPromise,await this.getFeatureFlagsAndPayloadsStateless(a,b,c,d,e,f)}async getFeatureFlagsAndPayloadsStateless(a,b={},c={},d={},e,f){await this._initPromise;let g=await this.getFeatureFlagDetailsStateless(a,b,c,d,e,f);return g?{flags:g.featureFlags,payloads:g.featureFlagPayloads,requestId:g.requestId}:{flags:void 0,payloads:void 0,requestId:void 0}}async getFeatureFlagDetailsStateless(a,b={},c={},d={},e,f){await this._initPromise;let g={};(e??this.disableGeoip)&&(g.geoip_disable=!0),f&&(g.flag_keys_to_evaluate=f);let h=await this.getFlags(a,b,c,d,g);if(void 0!==h)return(h.errorsWhileComputingFlags&&console.error("[FEATURE FLAGS] Error while computing feature flags, some flags may be missing or incorrect. Learn more at https://posthog.com/docs/feature-flags/best-practices"),h.quotaLimited?.includes("feature_flags"))?(console.warn("[FEATURE FLAGS] Feature flags quota limit exceeded - feature flags unavailable. Learn more about billing limits at https://posthog.com/docs/billing/limits-alerts"),{flags:{},featureFlags:{},featureFlagPayloads:{},requestId:h?.requestId}):h}async getSurveysStateless(){if(await this._initPromise,!0===this.disableSurveys)return this._logger.info("Loading surveys is disabled."),[];let a=`${this.host}/api/surveys/?token=${this.apiKey}`,b={method:"GET",headers:{...this.getCustomHeaders(),"Content-Type":"application/json"}},c=await this.fetchWithRetry(a,b).then(a=>{if(200!==a.status||!a.json){let b=`Surveys API could not be loaded: ${a.status}`,c=Error(b);this._logger.error(c),this._events.emit("error",Error(b));return}return a.json()}).catch(a=>{this._logger.error("Surveys API could not be loaded",a),this._events.emit("error",a)}),d=c?.surveys;return d&&this._logger.info("Surveys fetched from API: ",JSON.stringify(d)),d??[]}get props(){return this._props||(this._props=this.getPersistedProperty(u.Props)),this._props||{}}set props(a){this._props=a}async register(a){this.wrap(()=>{this.props={...this.props,...a},this.setPersistedProperty(u.Props,this.props)})}async unregister(a){this.wrap(()=>{delete this.props[a],this.setPersistedProperty(u.Props,this.props)})}enqueue(a,b,c){this.wrap(()=>{if(this.optedOut)return void this._events.emit(a,"Library is disabled. Not sending event. To re-enable, call posthog.optIn()");let d=this.prepareMessage(a,b,c),e=this.getPersistedProperty(u.Queue)||[];e.length>=this.maxQueueSize&&(e.shift(),this._logger.info("Queue is full, the oldest event is dropped.")),e.push({message:d}),this.setPersistedProperty(u.Queue,e),this._events.emit(a,d),e.length>=this.flushAt&&this.flushBackground(),this.flushInterval&&!this._flushTimer&&(this._flushTimer=ap(()=>this.flushBackground(),this.flushInterval))})}async sendImmediate(a,b,c){if(this.disabled)return void this._logger.warn("The client is disabled");if(this._isInitialized||await this._initPromise,this.optedOut)return void this._events.emit(a,"Library is disabled. Not sending event. To re-enable, call posthog.optIn()");let d={api_key:this.apiKey,batch:[this.prepareMessage(a,b,c)],sent_at:ao()};this.historicalMigration&&(d.historical_migration=!0);let e=JSON.stringify(d),f=`${this.host}/batch/`,g=this.disableCompression?null:await av(e,this.isDebug),h={method:"POST",headers:{...this.getCustomHeaders(),"Content-Type":"application/json",...null!==g&&{"Content-Encoding":"gzip"}},body:g||e};try{await this.fetchWithRetry(f,h)}catch(a){this._events.emit("error",a)}}prepareMessage(a,b,c){let d={...b,type:a,library:this.getLibraryId(),library_version:this.getLibraryVersion(),timestamp:c?.timestamp?c?.timestamp:ao(),uuid:c?.uuid?c.uuid:r().toString()};return(c?.disableGeoip??this.disableGeoip)&&(d.properties||(d.properties={}),d.properties.$geoip_disable=!0),d.distinctId&&(d.distinct_id=d.distinctId,delete d.distinctId),d}clearFlushTimer(){this._flushTimer&&(clearTimeout(this._flushTimer),this._flushTimer=void 0)}flushBackground(){this.flush().catch(async a=>{await ay(a)})}async flush(){let a=at([this.flushPromise]).then(()=>this._flush());return this.flushPromise=a,this.addPendingPromise(a),at([a]).then(()=>{this.flushPromise===a&&(this.flushPromise=null)}),a}getCustomHeaders(){let a=this.getCustomUserAgent(),b={};return a&&""!==a&&(b["User-Agent"]=a),b}async _flush(){this.clearFlushTimer(),await this._initPromise;let a=this.getPersistedProperty(u.Queue)||[];if(!a.length)return;let b=[],c=a.length;for(;a.length>0&&b.length<c;){let c=a.slice(0,this.maxBatchSize),d=c.map(a=>a.message),e=()=>{let b=(this.getPersistedProperty(u.Queue)||[]).slice(c.length);this.setPersistedProperty(u.Queue,b),a=b},f={api_key:this.apiKey,batch:d,sent_at:ao()};this.historicalMigration&&(f.historical_migration=!0);let g=JSON.stringify(f),h=`${this.host}/batch/`,i=this.disableCompression?null:await av(g,this.isDebug),j={method:"POST",headers:{...this.getCustomHeaders(),"Content-Type":"application/json",...null!==i&&{"Content-Encoding":"gzip"}},body:i||g},k={retryCheck:a=>!aA(a)&&az(a)};try{await this.fetchWithRetry(h,j,k)}catch(a){if(aA(a)&&d.length>1){this.maxBatchSize=Math.max(1,Math.floor(d.length/2)),this._logger.warn(`Received 413 when sending batch of size ${d.length}, reducing batch size to ${this.maxBatchSize}`);continue}throw a instanceof ax||e(),this._events.emit("error",a),a}e(),b.push(...d)}this._events.emit("flush",b)}async fetchWithRetry(a,b,c,d){AbortSignal.timeout??=function(a){let b=new AbortController;return setTimeout(()=>b.abort(),a),b.signal};let e=b.body?b.body:"",f=-1;try{f=e instanceof Blob?e.size:Buffer.byteLength(e,aj)}catch{f=e instanceof Blob?e.size:new TextEncoder().encode(e).length}return await am(async()=>{let c=null;try{c=await this.fetch(a,{signal:AbortSignal.timeout(d??this.requestTimeout),...b})}catch(a){throw new ax(a)}if("no-cors"!==b.mode&&(c.status<200||c.status>=400))throw new aw(c,f);return c},{...this._retryOptions,...c})}async _shutdown(a=3e4){await this._initPromise;let b=!1;this.clearFlushTimer();let c=async()=>{try{for(await this.promiseQueue.join();;){let a=this.getPersistedProperty(u.Queue)||[];if(0===a.length||(await this.flush(),b))break}}catch(a){if(!az(a))throw a;await ay(a)}};return Promise.race([new Promise((c,d)=>{ap(()=>{this._logger.error("Timed out while shutting down PostHog"),b=!0,d("Timeout while shutting down PostHog. Some events may not have been sent.")},a)}),c()])}async shutdown(a=3e4){return this.shutdownPromise?this._logger.warn("shutdown() called while already shutting down. shutdown() is meant to be called once before process exit - use flush() for per-request cleanup"):this.shutdownPromise=this._shutdown(a).finally(()=>{this.shutdownPromise=null}),this.shutdownPromise}}class aC{constructor(a,b,c=[]){this.coercers=a,this.stackParser=b,this.modifiers=c}buildFromUnknown(a,b={}){let c=b&&b.mechanism||{handled:!0,type:"generic"},d=this.buildCoercingContext(c,b,0).apply(a),e=this.buildParsingContext(),f=this.parseStacktrace(d,e);return{$exception_list:this.convertToExceptionList(f,c),$exception_level:"error"}}async modifyFrames(a){for(let b of a)b.stacktrace&&b.stacktrace.frames&&E(b.stacktrace.frames)&&(b.stacktrace.frames=await this.applyModifiers(b.stacktrace.frames));return a}coerceFallback(a){return{type:"Error",value:"Unknown error",stack:a.syntheticException?.stack,synthetic:!0}}parseStacktrace(a,b){let c,d;return null!=a.cause&&(c=this.parseStacktrace(a.cause,b)),""!=a.stack&&null!=a.stack&&(d=this.applyChunkIds(this.stackParser(a.stack,+!!a.synthetic),b.chunkIdMap)),{...a,cause:c,stack:d}}applyChunkIds(a,b){return a.map(a=>(a.filename&&b&&(a.chunk_id=b[a.filename]),a))}applyCoercers(a,b){for(let c of this.coercers)if(c.match(a))return c.coerce(a,b);return this.coerceFallback(b)}async applyModifiers(a){let b=a;for(let a of this.modifiers)b=await a(b);return b}convertToExceptionList(a,b){let c={type:a.type,value:a.value,mechanism:{type:b.type??"generic",handled:b.handled??!0,synthetic:a.synthetic??!1}};a.stack&&(c.stacktrace={type:"raw",frames:a.stack});let d=[c];return null!=a.cause&&d.push(...this.convertToExceptionList(a.cause,{...b,handled:!0})),d}buildParsingContext(){return{chunkIdMap:function(a){let b=globalThis._posthogChunkIds;if(!b)return;let f=Object.keys(b);return e&&f.length===d?e:(d=f.length,e=f.reduce((d,e)=>{c||(c={});let f=c[e];if(f)d[f[0]]=f[1];else{let f=a(e);for(let a=f.length-1;a>=0;a--){let g=f[a],h=g?.filename,i=b[e];if(h&&i){d[h]=i,c[e]=[h,i];break}}}return d},{}))}(this.stackParser)}}buildCoercingContext(a,b,c=0){let d=(c,d)=>{if(d<=4){let e=this.buildCoercingContext(a,b,d);return this.applyCoercers(c,e)}};return{...b,syntheticException:0==c?b.syntheticException:void 0,mechanism:a,apply:a=>d(a,c),next:a=>d(a,c+1)}}}function aD(a,b,c,d,e){let f={platform:a,filename:b,function:"<anonymous>"===c?"?":c,in_app:!0};return J(d)||(f.lineno=d),J(e)||(f.colno=e),f}a.s(["ErrorPropertiesBuilder",()=>aC],6762);let aE=(a,b)=>{let c=-1!==a.indexOf("safari-extension"),d=-1!==a.indexOf("safari-web-extension");return c||d?[-1!==a.indexOf("@")?a.split("@")[0]:"?",c?`safari-extension:${b}`:`safari-web-extension:${b}`]:[a,b]},aF=/^\s*at (\S+?)(?::(\d+))(?::(\d+))\s*$/i,aG=/^\s*at (?:(.+?\)(?: \[.+\])?|.*?) ?\((?:address at )?)?(?:async )?((?:<anonymous>|[-a-z]+:|.*bundle|\/)?.*?)(?::(\d+))?(?::(\d+))?\)?\s*$/i,aH=/\((\S*)(?::(\d+))(?::(\d+))\)/,aI=(a,b)=>{let c=aF.exec(a);if(c){let[,a,d,e]=c;return aD(b,a,"?",+d,+e)}let d=aG.exec(a);if(d){if(d[2]&&0===d[2].indexOf("eval")){let a=aH.exec(d[2]);a&&(d[2]=a[1],d[3]=a[2],d[4]=a[3])}let[a,c]=aE(d[1]||"?",d[2]);return aD(b,c,a,d[3]?+d[3]:void 0,d[4]?+d[4]:void 0)}},aJ=/^\s*at (?:((?:\[object object\])?.+) )?\(?((?:[-a-z]+):.*?):(\d+)(?::(\d+))?\)?\s*$/i,aK=(a,b)=>{let c=aJ.exec(a);return c?aD(b,c[2],c[1]||"?",+c[3],c[4]?+c[4]:void 0):void 0},aL=/^\s*(.*?)(?:\((.*?)\))?(?:^|@)?((?:[-a-z]+)?:\/.*?|\[native code\]|[^@]*(?:bundle|\d+\.js)|\/[\w\-. /=]+)(?::(\d+))?(?::(\d+))?\s*$/i,aM=/(\S+) line (\d+)(?: > eval line \d+)* > eval/i,aN=(a,b)=>{let c=aL.exec(a);if(c){if(c[3]&&c[3].indexOf(" > eval")>-1){let a=aM.exec(c[3]);a&&(c[1]=c[1]||"eval",c[3]=a[1],c[4]=a[2],c[5]="")}let a=c[3],d=c[1]||"?";return[d,a]=aE(d,a),aD(b,a,d,c[4]?+c[4]:void 0,c[5]?+c[5]:void 0)}},aO=/ line (\d+).*script (?:in )?(\S+)(?:: in function (\S+))?$/i,aP=(a,b)=>{let c=aO.exec(a);return c?aD(b,c[2],c[3]||"?",+c[1]):void 0},aQ=/ line (\d+), column (\d+)\s*(?:in (?:<anonymous function: ([^>]+)>|([^)]+))\(.*\))? in (.*):\s*$/i,aR=(a,b)=>{let c=aQ.exec(a);return c?aD(b,c[5],c[3]||c[4]||"?",+c[1],+c[2]):void 0},aS=/^\s*[-]{4,}$/,aT=/at (?:async )?(?:(.+?)\s+\()?(?:(.+):(\d+):(\d+)?|([^)]+))\)?/,aU=(a,b)=>{let c=a.match(aT);if(c){let a,d,e,f,g;if(c[1]){let b=(e=c[1]).lastIndexOf(".");if("."===e[b-1]&&b--,b>0){a=e.slice(0,b),d=e.slice(b+1);let c=a.indexOf(".Module");c>0&&(e=e.slice(c+1),a=a.slice(0,c))}f=void 0}d&&(f=a,g=d),"<anonymous>"===d&&(g=void 0,e=void 0),void 0===e&&(g=g||"?",e=f?`${f}.${g}`:g);let h=c[2]?.startsWith("file://")?c[2].slice(7):c[2],i="native"===c[5];return h?.match(/\/[A-Z]:/)&&(h=h.slice(1)),h||!c[5]||i||(h=c[5]),{filename:h?decodeURI(h):void 0,module:void 0,function:e,lineno:aV(c[3]),colno:aV(c[4]),in_app:function(a,b=!1){return!(b||a&&!a.startsWith("/")&&!a.match(/^[A-Z]:/)&&!a.startsWith(".")&&!a.match(/^[a-zA-Z]([a-zA-Z0-9.\-+])*:\/\//))&&void 0!==a&&!a.includes("node_modules/")}(h||"",i),platform:b}}if(a.match(aS))return{filename:a,platform:b}};function aV(a){return parseInt(a||"",10)||void 0}let aW=/\(error: (.*)\)/;function aX(a){if(!a.length)return[];let b=Array.from(a);return b.reverse(),b.slice(0,50).map(a=>{var c;return{...a,filename:a.filename||((c=b)[c.length-1]||{}).filename,function:a.function||"?"}})}function aY(a,...b){return(c,d=0)=>{let e=[],f=c.split("\n");for(let c=d;c<f.length;c++){let d=f[c];if(d.length>1024)continue;let g=aW.test(d)?d.replace(aW,"$1"):d;if(!g.match(/\S*Error: /)){for(let c of b){let b=c(g,a);if(b){e.push(b);break}}if(e.length>=50)break}}return aX(e)}}a.s(["createStackParser",()=>aY,"reverseAndStripFrames",()=>aX],67970);class aZ{match(a){return this.isDOMException(a)||this.isDOMError(a)}coerce(a,b){let c=K(a.stack);return{type:this.getType(a),value:this.getValue(a),stack:c?a.stack:void 0,cause:a.cause?b.next(a.cause):void 0,synthetic:!1}}getType(a){return this.isDOMError(a)?"DOMError":"DOMException"}getValue(a){let b=a.name||(this.isDOMError(a)?"DOMError":"DOMException");return a.message?`${b}: ${a.message}`:b}isDOMException(a){return W(a,"DOMException")}isDOMError(a){return W(a,"DOMError")}}a.s(["DOMExceptionCoercer",()=>aZ],51671);class a${match(a){return S(a)}coerce(a,b){return{type:this.getType(a),value:this.getMessage(a,b),stack:this.getStack(a),cause:a.cause?b.next(a.cause):void 0,synthetic:!1}}getType(a){return a.name||a.constructor.name}getMessage(a,b){let c=a.message;return c.error&&"string"==typeof c.error.message?String(c.error.message):String(c)}getStack(a){return a.stacktrace||a.stack||void 0}}a.s(["ErrorCoercer",()=>a$],10692);class a_{constructor(){}match(a){return Y(a)&&void 0!=a.error}coerce(a,b){let c=b.apply(a.error);return c||{type:"ErrorEvent",value:a.message,stack:b.syntheticException?.stack,synthetic:!0}}}a.s(["ErrorEventCoercer",()=>a_],75368);let a0=/^(?:[Uu]ncaught (?:exception: )?)?(?:((?:Eval|Internal|Range|Reference|Syntax|Type|URI|)Error): )?(.*)$/i;class a1{match(a){return"string"==typeof a}coerce(a,b){let[c,d]=this.getInfos(a);return{type:c??"Error",value:d??a,stack:b.syntheticException?.stack,synthetic:!0}}getInfos(a){let b="Error",c=a,d=a.match(a0);return d&&(b=d[1],c=d[2]),[b,c]}}a.s(["StringCoercer",()=>a1],57802);let a2=["fatal","error","warning","log","info","debug"];function a3(a,b=40){let c=Object.keys(a);if(c.sort(),!c.length)return"[object has no keys]";for(let a=c.length;a>0;a--){let d=c.slice(0,a).join(", ");if(!(d.length>b)){if(a===c.length)return d;return d.length<=b?d:`${d.slice(0,b)}...`}}return""}class a4{match(a){return"object"==typeof a&&null!==a}coerce(a,b){let c=this.getErrorPropertyFromObject(a);return c?b.apply(c):{type:this.getType(a),value:this.getValue(a),stack:b.syntheticException?.stack,level:this.isSeverityLevel(a.level)?a.level:"error",synthetic:!0}}getType(a){return Z(a)?a.constructor.name:"Error"}getValue(a){if("name"in a&&"string"==typeof a.name){let b=`'${a.name}' captured as exception`;return"message"in a&&"string"==typeof a.message&&(b+=` with message: '${a.message}'`),b}if("message"in a&&"string"==typeof a.message)return a.message;let b=this.getObjectClassName(a),c=a3(a);return`${b&&"Object"!==b?`'${b}'`:"Object"} captured as exception with keys: ${c}`}isSeverityLevel(a){return K(a)&&!L(a)&&a2.indexOf(a)>=0}getErrorPropertyFromObject(a){for(let b in a)if(Object.prototype.hasOwnProperty.call(a,b)){let c=a[b];if(ar(c))return c}}getObjectClassName(a){try{let b=Object.getPrototypeOf(a);return b?b.constructor.name:void 0}catch(a){return}}}a.s(["ObjectCoercer",()=>a4],93874);class a5{match(a){return Z(a)}coerce(a,b){let c=a.constructor.name;return{type:c,value:`${c} captured as exception with keys: ${a3(a)}`,stack:b.syntheticException?.stack,synthetic:!0}}}a.s(["EventCoercer",()=>a5],46980);class a6{match(a){return V(a)}coerce(a,b){return{type:"Error",value:`Primitive value captured as exception: ${String(a)}`,stack:b.syntheticException?.stack,synthetic:!0}}}a.s(["PrimitiveCoercer",()=>a6],28150);class a7{match(a){return W(a,"PromiseRejectionEvent")}coerce(a,b){let c=this.getUnhandledRejectionReason(a);return V(c)?{type:"UnhandledRejection",value:`Non-Error promise rejection captured with value: ${String(c)}`,stack:b.syntheticException?.stack,synthetic:!0}:b.apply(c)}getUnhandledRejectionReason(a){if(V(a))return a;try{if("reason"in a)return a.reason;if("detail"in a&&"reason"in a.detail)return a.detail.reason}catch{}return a}}a.s(["PromiseRejectionEventCoercer",()=>a7],98140),a.s([],7610);class a8{constructor(a){this._maxSize=a,this._cache=new Map}get(a){let b=this._cache.get(a);if(void 0!==b)return this._cache.delete(a),this._cache.set(a,b),b}set(a,b){this._cache.set(a,b)}reduce(){for(;this._cache.size>=this._maxSize;){let a=this._cache.keys().next().value;a&&this._cache.delete(a)}}}a.s(["ReduceableCache",()=>a8],98966),a.s([],48153),a.i(48153),a.i(6762),a.i(67970),a.s(["chromeStackLineParser",()=>aI,"createStackParser",()=>aY,"geckoStackLineParser",()=>aN,"nodeStackLineParser",()=>aU,"opera10StackLineParser",()=>aP,"opera11StackLineParser",()=>aR,"reverseAndStripFrames",()=>aX,"winjsStackLineParser",()=>aK],64583),a.i(64583),a.i(7610),a.i(51671),a.i(10692),a.i(75368),a.i(57802),a.i(93874),a.i(46980),a.i(28150),a.i(98140),a.s(["DOMExceptionCoercer",()=>aZ,"ErrorCoercer",()=>a$,"ErrorEventCoercer",()=>a_,"EventCoercer",()=>a5,"ObjectCoercer",()=>a4,"PrimitiveCoercer",()=>a6,"PromiseRejectionEventCoercer",()=>a7,"StringCoercer",()=>a1],54253),a.i(54253),a.i(98966),a.s(["DOMExceptionCoercer",()=>aZ,"ErrorCoercer",()=>a$,"ErrorEventCoercer",()=>a_,"ErrorPropertiesBuilder",()=>aC,"EventCoercer",()=>a5,"ObjectCoercer",()=>a4,"PrimitiveCoercer",()=>a6,"PromiseRejectionEventCoercer",()=>a7,"ReduceableCache",()=>a8,"StringCoercer",()=>a1,"chromeStackLineParser",()=>aI,"createStackParser",()=>aY,"geckoStackLineParser",()=>aN,"nodeStackLineParser",()=>aU,"opera10StackLineParser",()=>aP,"opera11StackLineParser",()=>aR,"reverseAndStripFrames",()=>aX,"winjsStackLineParser",()=>aK],60485);var a9=a.i(60485),ba=a9,bb=a.i(2157),bc=a.i(1457);let bd=new ba.ReduceableCache(25),be=new ba.ReduceableCache(20);async function bf(a){let b={};for(let e=a.length-1;e>=0;e--){var c,d;let f=a[e],g=f?.filename;!(!f||"string"!=typeof g||"number"!=typeof f.lineno||(c=g).startsWith("node:")||c.endsWith(".min.js")||c.endsWith(".min.cjs")||c.endsWith(".min.mjs")||c.startsWith("data:")||void 0!==(d=f).lineno&&d.lineno>1e4||void 0!==d.colno&&d.colno>1e3)&&(b[g]||(b[g]=[]),b[g].push(f.lineno))}let e=Object.keys(b);if(0==e.length)return a;let f=[];for(let a of e){if(be.get(a))continue;let c=b[a];if(!c)continue;c.sort((a,b)=>a-b);let d=function(a){if(!a.length)return[];let b=0,c=a[0];if("number"!=typeof c)return[];let d=bh(c),e=[];for(;;){if(b===a.length-1){e.push(d);break}let c=a[b+1];if("number"!=typeof c)break;c<=d[1]?d[1]=c+7:(e.push(d),d=bh(c)),b++}return e}(c);if(d.every(b=>(function(a,b){let c=bd.get(a);if(void 0===c)return!1;for(let a=b[0];a<=b[1];a++)if(void 0===c[a])return!1;return!0})(a,b)))continue;let e=function(a,b,c){let d=a.get(b);return void 0===d?(a.set(b,c),c):d}(bd,a,{});f.push(function(a,b,c){return new Promise(d=>{let e=(0,bb.createReadStream)(a),f=(0,bc.createInterface)({input:e});function g(){e.destroy(),d()}let h=0,i=0,j=b[0];if(void 0===j)return void g();let k=j[0],l=j[1];function m(){be.set(a,1),f.close(),f.removeAllListeners(),g()}e.on("error",m),f.on("error",m),f.on("close",g),f.on("line",a=>{if(!(++h<k)&&(c[h]=function(a,b){let c=a,d=c.length;if(d<=150)return c;b>d&&(b=d);let e=Math.max(b-60,0);e<5&&(e=0);let f=Math.min(e+140,d);return f>d-5&&(f=d),f===d&&(e=Math.max(f-140,0)),c=c.slice(e,f),e>0&&(c=`...${c}`),f<d&&(c+="..."),c}(a,0),h>=l)){if(i===b.length-1){f.close(),f.removeAllListeners();return}let a=b[++i];if(void 0===a){f.close(),f.removeAllListeners();return}k=a[0],l=a[1]}})})}(a,d,e))}return await Promise.all(f).catch(()=>{}),a&&a.length>0&&function(a,b){for(let c of a)if(c.filename&&void 0===c.context_line&&"number"==typeof c.lineno){let a=b.get(c.filename);if(void 0===a)continue;!function(a,b,c){if(void 0===b.lineno||void 0===c)return;b.pre_context=[];for(let d=bi(a);d<a;d++){let a=c[d];if(void 0===a)return void bg(b);b.pre_context.push(a)}if(void 0===c[a])return bg(b);b.context_line=c[a];let d=function(a){return a+7}(a);b.post_context=[];for(let e=a+1;e<=d;e++){let a=c[e];if(void 0===a)break;b.post_context.push(a)}}(c.lineno,c,a)}}(a,bd),bd.reduce(),a}function bg(a){delete a.pre_context,delete a.context_line,delete a.post_context}function bh(a){return[bi(a),a+7]}function bi(a){return Math.max(1,a-7)}class bj{constructor(a,b,c){this.client=a,this._exceptionAutocaptureEnabled=b.enableExceptionAutocapture||!1,this._logger=c,this._rateLimiter=new ae({refillRate:1,bucketSize:10,refillInterval:1e4,_logger:this._logger}),this.startAutocaptureIfEnabled()}static async buildEventMessage(a,b,c,d){let e={...d};c||(e.$process_person_profile=!1);let f=this.errorPropertiesBuilder.buildFromUnknown(a,b);return f.$exception_list=await this.errorPropertiesBuilder.modifyFrames(f.$exception_list),{event:"$exception",distinctId:c||r().toString(),properties:{...f,...e}}}startAutocaptureIfEnabled(){if(this.isEnabled()){var b,c,d;let e;b=this.onException.bind(this),c=this.onFatalError.bind(this),a.g.process.on("uncaughtException",(e=!1,Object.assign(d=>{let f=a.g.process.listeners("uncaughtException").filter(a=>"domainUncaughtExceptionClear"!==a.name&&!0!==a._posthogErrorHandler).length;b(d,{mechanism:{type:"onuncaughtexception",handled:!1}}),e||0!==f||(e=!0,c(d))},{_posthogErrorHandler:!0}))),d=this.onException.bind(this),a.g.process.on("unhandledRejection",a=>d(a,{mechanism:{type:"onunhandledrejection",handled:!1}}))}}onException(a,b){this.client.addPendingPromise((async()=>{let c=await bj.buildEventMessage(a,b),d=c.properties,e=d?.$exception_list[0]?.type??"Exception";return this._rateLimiter.consumeRateLimit(e)?void this._logger.info("Skipping exception capture because of client rate limiting.",{exception:e}):this.client.capture(c)})())}async onFatalError(a){console.error(a),await this.client.shutdown(2e3),process.exit(1)}isEnabled(){return!this.client.isDisabled&&this._exceptionAutocaptureEnabled}shutdown(){this._rateLimiter.stop()}}async function bk(a){let b=globalThis.crypto?.subtle;if(!b)throw Error("SubtleCrypto API not available");return Array.from(new Uint8Array(await b.digest("SHA-1",new TextEncoder().encode(a)))).map(a=>a.toString(16).padStart(2,"0")).join("")}a.i(38785),a.i(19673),a.i(48301),a.i(18238),a.i(85314),a.i(73117),a.i(20981),a.i(99410);let bl=["is_not"];class bm extends Error{constructor(a){super(),Error.captureStackTrace(this,this.constructor),this.name="ClientError",this.message=a,Object.setPrototypeOf(this,bm.prototype)}}class bn extends Error{constructor(a){super(a),this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor),Object.setPrototypeOf(this,bn.prototype)}}class bo extends Error{constructor(a){super(a),this.name=this.constructor.name,Error.captureStackTrace(this,this.constructor),Object.setPrototypeOf(this,bo.prototype)}}class bp{constructor({pollingInterval:a,personalApiKey:b,projectApiKey:c,timeout:d,host:e,customHeaders:f,...g}){this.debugMode=!1,this.shouldBeginExponentialBackoff=!1,this.backOffCount=0,this.hasAttemptedCacheLoad=!1,this.pollingInterval=a,this.personalApiKey=b,this.featureFlags=[],this.featureFlagsByKey={},this.groupTypeMapping={},this.cohorts={},this.loadedSuccessfullyOnce=!1,this.timeout=d,this.projectApiKey=c,this.host=e,this.poller=void 0,this.fetch=g.fetch||fetch,this.onError=g.onError,this.customHeaders=f,this.onLoad=g.onLoad,this.cacheProvider=g.cacheProvider,this.loadFeatureFlags()}debug(a=!0){this.debugMode=a}logMsgIfDebug(a){this.debugMode&&a()}async getFeatureFlag(a,b,c={},d={},e={}){let f,g;if(await this.loadFeatureFlags(),!this.loadedSuccessfullyOnce)return f;if(void 0!==(g=this.featureFlagsByKey[a]))try{f=(await this.computeFlagAndPayloadLocally(g,b,c,d,e)).value,this.logMsgIfDebug(()=>console.debug(`Successfully computed flag locally: ${a} -> ${f}`))}catch(b){b instanceof bo||b instanceof bn?this.logMsgIfDebug(()=>console.debug(`${b.name} when computing flag locally: ${a}: ${b.message}`)):b instanceof Error&&this.onError?.(Error(`Error computing flag locally: ${a}: ${b}`))}return f}async getAllFlagsAndPayloads(a,b={},c={},d={},e){await this.loadFeatureFlags();let f={},g={},h=0==this.featureFlags.length,i=e?e.map(a=>this.featureFlagsByKey[a]).filter(Boolean):this.featureFlags,j={};return await Promise.all(i.map(async e=>{try{let{value:h,payload:i}=await this.computeFlagAndPayloadLocally(e,a,b,c,d,void 0,j);f[e.key]=h,i&&(g[e.key]=i)}catch(a){a instanceof bo||a instanceof bn?this.logMsgIfDebug(()=>console.debug(`${a.name} when computing flag locally: ${e.key}: ${a.message}`)):a instanceof Error&&this.onError?.(Error(`Error computing flag locally: ${e.key}: ${a}`)),h=!0}})),{response:f,payloads:g,fallbackToFlags:h}}async computeFlagAndPayloadLocally(a,b,c={},d={},e={},f,g,h=!1){let i;if(h||await this.loadFeatureFlags(),!this.loadedSuccessfullyOnce)return{value:!1,payload:null};i=void 0!==f?f:await this.computeFlagValueLocally(a,b,c,d,e,g);let j=this.getFeatureFlagPayload(a.key,i);return{value:i,payload:j}}async computeFlagValueLocally(a,b,c={},d={},e={},f={}){if(a.ensure_experience_continuity)throw new bn("Flag has experience continuity enabled");if(!a.active)return!1;let g=(a.filters||{}).aggregation_group_type_index;if(void 0==g)return await this.matchFeatureFlagProperties(a,b,d,f);{let b=this.groupTypeMapping[String(g)];if(!b)throw this.logMsgIfDebug(()=>console.warn(`[FEATURE FLAGS] Unknown group type index ${g} for feature flag ${a.key}`)),new bn("Flag has unknown group type index");if(!(b in c))return this.logMsgIfDebug(()=>console.warn(`[FEATURE FLAGS] Can't compute group feature flag: ${a.key} without group names passed in`)),!1;let d=e[b];return await this.matchFeatureFlagProperties(a,c[b],d,f)}}getFeatureFlagPayload(a,b){let c=null;if(!1!==b&&null!=b&&("boolean"==typeof b?c=this.featureFlagsByKey?.[a]?.filters?.payloads?.[b.toString()]||null:"string"==typeof b&&(c=this.featureFlagsByKey?.[a]?.filters?.payloads?.[b]||null),null!=c)){if("object"==typeof c)return c;if("string"==typeof c)try{return JSON.parse(c)}catch{}return c}return null}async evaluateFlagDependency(a,b,c,d){let e=a.key;if(!this.featureFlagsByKey)throw new bn("Feature flags not available for dependency evaluation");if(!("dependency_chain"in a))throw new bn(`Flag dependency property for '${e}' is missing required 'dependency_chain' field`);let f=a.dependency_chain;if(!Array.isArray(f))throw new bn(`Flag dependency property for '${e}' has an invalid 'dependency_chain' (expected array, got ${typeof f})`);if(0===f.length)throw new bn(`Circular dependency detected for flag '${e}' (empty dependency chain)`);for(let a of f){if(!(a in d)){let f=this.featureFlagsByKey[a];if(f)if(f.active)try{let e=await this.matchFeatureFlagProperties(f,b,c,d);d[a]=e}catch(b){throw new bn(`Error evaluating flag dependency '${a}' for flag '${e}': ${b}`)}else d[a]=!1;else throw new bn(`Missing flag dependency '${a}' for flag '${e}'`)}if(null==d[a])throw new bn(`Dependency '${a}' could not be evaluated`)}let g=d[e];return this.flagEvaluatesToExpectedValue(a.value,g)}flagEvaluatesToExpectedValue(a,b){return"boolean"==typeof a?a===b||"string"==typeof b&&""!==b&&!0===a:"string"==typeof a&&b===a}async matchFeatureFlagProperties(a,b,c,d={}){let e,f=a.filters||{},g=f.groups||[],h=!1;for(let i of g)try{if(await this.isConditionMatch(a,b,i,c,d)){let c=i.variant,d=f.multivariate?.variants||[];e=c&&d.some(a=>a.key===c)?c:await this.getMatchingVariant(a,b)||!0;break}}catch(a){if(a instanceof bo)throw a;if(a instanceof bn)h=!0;else throw a}if(void 0!==e)return e;if(h)throw new bn("Can't determine if feature flag is enabled or not with given properties");return!1}async isConditionMatch(a,b,c,d,e={}){let f=c.rollout_percentage,g=a=>{this.logMsgIfDebug(()=>console.warn(a))};if((c.properties||[]).length>0){for(let a of c.properties){let c=a.type;if(!("cohort"===c?function a(b,c,d,e=!1){let f=String(b.value);if(!(f in d))throw new bo(`cohort ${f} not found in local cohorts - likely a static cohort that requires server evaluation`);return function b(c,d,e,f=!1){if(!c)return!0;let g=c.type,h=c.values;if(!h||0===h.length)return!0;let i=!1;if("values"in h[0]){for(let a of h)try{let c=b(a,d,e,f);if("AND"===g){if(!c)return!1}else if(c)return!0}catch(b){if(b instanceof bo)throw b;if(b instanceof bn)f&&console.debug(`Failed to compute property ${a} locally: ${b}`),i=!0;else throw b}if(i)throw new bn("Can't match cohort without a given cohort property value");return"AND"===g}for(let b of h)try{let c;if("cohort"===b.type)c=a(b,d,e,f);else if("flag"===b.type){f&&console.warn(`[FEATURE FLAGS] Flag dependency filters are not supported in local evaluation. Skipping condition with dependency on flag '${b.key||"unknown"}'`);continue}else c=br(b,d);let h=b.negation||!1;if("AND"===g){if(!c&&!h||c&&h)return!1}else if(c&&!h||!c&&h)return!0}catch(a){if(a instanceof bo)throw a;if(a instanceof bn)f&&console.debug(`Failed to compute property ${b} locally: ${a}`),i=!0;else throw a}if(i)throw new bn("can't match cohort without a given cohort property value");return"AND"===g}(d[f],c,d,e)}(a,d,this.cohorts,this.debugMode):"flag"===c?await this.evaluateFlagDependency(a,b,d,e):br(a,d,g)))return!1}if(void 0==f)return!0}return!(void 0!=f&&await bq(a.key,b)>f/100)}async getMatchingVariant(a,b){let c=await bq(a.key,b,"variant"),d=this.variantLookupTable(a).find(a=>c>=a.valueMin&&c<a.valueMax);if(d)return d.key}variantLookupTable(a){let b=[],c=0,d=0,e=a.filters||{};return(e.multivariate?.variants||[]).forEach(a=>{d=c+a.rollout_percentage/100,b.push({valueMin:c,valueMax:d,key:a.key}),c=d}),b}updateFlagState(a){this.featureFlags=a.flags,this.featureFlagsByKey=a.flags.reduce((a,b)=>(a[b.key]=b,a),{}),this.groupTypeMapping=a.groupTypeMapping,this.cohorts=a.cohorts,this.loadedSuccessfullyOnce=!0}async loadFromCache(a){if(!this.cacheProvider)return!1;try{let b=await this.cacheProvider.getFlagDefinitions();if(b)return this.updateFlagState(b),this.logMsgIfDebug(()=>console.debug(`[FEATURE FLAGS] ${a} (${b.flags.length} flags)`)),this.onLoad?.(this.featureFlags.length),!0;return!1}catch(a){return this.onError?.(Error(`Failed to load from cache: ${a}`)),!1}}async loadFeatureFlags(a=!1){if(this.cacheProvider&&!this.hasAttemptedCacheLoad&&(this.hasAttemptedCacheLoad=!0,await this.loadFromCache("Loaded flags from cache")),this.loadingPromise)return this.loadingPromise;(!this.loadedSuccessfullyOnce||a)&&(this.loadingPromise=this._loadFeatureFlags(),await this.loadingPromise)}isLocalEvaluationReady(){return(this.loadedSuccessfullyOnce??!1)&&(this.featureFlags?.length??0)>0}getPollingInterval(){return this.shouldBeginExponentialBackoff?Math.min(6e4,this.pollingInterval*2**this.backOffCount):this.pollingInterval}async _loadFeatureFlags(){this.poller&&(clearTimeout(this.poller),this.poller=void 0),this.poller=setTimeout(()=>this._loadFeatureFlags(),this.getPollingInterval());try{let a=!0;if(this.cacheProvider)try{a=await this.cacheProvider.shouldFetchFlagDefinitions()}catch(a){this.onError?.(Error(`Error in shouldFetchFlagDefinitions: ${a}`))}if(!a&&(await this.loadFromCache("Loaded flags from cache (skipped fetch)")||this.loadedSuccessfullyOnce))return;let b=await this._requestFeatureFlagDefinitions();if(!b)return;switch(b.status){case 401:throw this.shouldBeginExponentialBackoff=!0,this.backOffCount+=1,new bm(`Your project key or personal API key is invalid. Setting next polling interval to ${this.getPollingInterval()}ms. More information: https://posthog.com/docs/api#rate-limiting`);case 402:console.warn("[FEATURE FLAGS] Feature flags quota limit exceeded - unsetting all local flags. Learn more about billing limits at https://posthog.com/docs/billing/limits-alerts"),this.featureFlags=[],this.featureFlagsByKey={},this.groupTypeMapping={},this.cohorts={};return;case 403:throw this.shouldBeginExponentialBackoff=!0,this.backOffCount+=1,new bm(`Your personal API key does not have permission to fetch feature flag definitions for local evaluation. Setting next polling interval to ${this.getPollingInterval()}ms. Are you sure you're using the correct personal and Project API key pair? More information: https://posthog.com/docs/api/overview`);case 429:throw this.shouldBeginExponentialBackoff=!0,this.backOffCount+=1,new bm(`You are being rate limited. Setting next polling interval to ${this.getPollingInterval()}ms. More information: https://posthog.com/docs/api#rate-limiting`);case 200:{let c=await b.json()??{};if(!("flags"in c))return void this.onError?.(Error(`Invalid response when getting feature flags: ${JSON.stringify(c)}`));let d={flags:c.flags??[],groupTypeMapping:c.group_type_mapping||{},cohorts:c.cohorts||{}};if(this.updateFlagState(d),this.shouldBeginExponentialBackoff=!1,this.backOffCount=0,this.cacheProvider&&a)try{await this.cacheProvider.onFlagDefinitionsReceived(d)}catch(a){this.onError?.(Error(`Failed to store in cache: ${a}`))}this.onLoad?.(this.featureFlags.length);break}default:return}}catch(a){a instanceof bm&&this.onError?.(a)}finally{this.loadingPromise=void 0}}getPersonalApiKeyRequestOptions(a="GET"){return{method:a,headers:{...this.customHeaders,"Content-Type":"application/json",Authorization:`Bearer ${this.personalApiKey}`}}}_requestFeatureFlagDefinitions(){let a=`${this.host}/api/feature_flag/local_evaluation?token=${this.projectApiKey}&send_cohorts`,b=this.getPersonalApiKeyRequestOptions(),c=null;if(this.timeout&&"number"==typeof this.timeout){let a=new AbortController;c=ap(()=>{a.abort()},this.timeout),b.signal=a.signal}try{return(0,this.fetch)(a,b)}finally{clearTimeout(c)}}async stopPoller(a=3e4){if(clearTimeout(this.poller),this.cacheProvider)try{let b=this.cacheProvider.shutdown();b instanceof Promise&&await Promise.race([b,new Promise((b,c)=>setTimeout(()=>c(Error(`Cache shutdown timeout after ${a}ms`)),a))])}catch(a){this.onError?.(Error(`Error during cache shutdown: ${a}`))}}}async function bq(a,b,c=""){return parseInt((await bk(`${a}.${b}${c}`)).slice(0,15),16)/0x1000000000000000}function br(a,b,c){let d=a.key,e=a.value,f=a.operator||"exact";if(d in b){if("is_not_set"===f)throw new bn("Operator is_not_set is not supported")}else throw new bn(`Property ${d} not found in propertyValues`);let g=b[d];if(null==g&&!bl.includes(f))return c&&c(`Property ${d} cannot have a value of null/undefined with the ${f} operator`),!1;function h(a,b){return Array.isArray(a)?a.map(a=>String(a).toLowerCase()).includes(String(b).toLowerCase()):String(a).toLowerCase()===String(b).toLowerCase()}function i(a,b,c){if("gt"===c)return a>b;if("gte"===c)return a>=b;if("lt"===c)return a<b;if("lte"===c)return a<=b;throw Error(`Invalid operator: ${c}`)}switch(f){case"exact":return h(e,g);case"is_not":return!h(e,g);case"is_set":return d in b;case"icontains":return String(g).toLowerCase().includes(String(e).toLowerCase());case"not_icontains":return!String(g).toLowerCase().includes(String(e).toLowerCase());case"regex":return bs(String(e))&&null!==String(g).match(String(e));case"not_regex":return bs(String(e))&&null===String(g).match(String(e));case"gt":case"gte":case"lt":case"lte":{let a="number"==typeof e?e:null;if("string"==typeof e)try{a=parseFloat(e)}catch(a){}if(null==a||null==g)return i(String(g),String(e),f);if("string"==typeof g)return i(g,String(e),f);return i(g,a,f)}case"is_date_after":case"is_date_before":{if("boolean"==typeof e)throw new bn("Date operations cannot be performed on boolean values");let a=function(a){let b=a.match(/^-?(?<number>[0-9]+)(?<interval>[a-z])$/),c=new Date(new Date().toISOString());if(!b)return null;{if(!b.groups)return null;let a=parseInt(b.groups.number);if(a>=1e4)return null;let d=b.groups.interval;if("h"==d)c.setUTCHours(c.getUTCHours()-a);else if("d"==d)c.setUTCDate(c.getUTCDate()-a);else if("w"==d)c.setUTCDate(c.getUTCDate()-7*a);else if("m"==d)c.setUTCMonth(c.getUTCMonth()-a);else{if("y"!=d)return null;c.setUTCFullYear(c.getUTCFullYear()-a)}return c}}(String(e));if(null==a&&(a=bt(e)),null==a)throw new bn(`Invalid date: ${e}`);let b=bt(g);if(["is_date_before"].includes(f))return b<a;return b>a}default:throw new bn(`Unknown operator: ${f}`)}}function bs(a){try{return new RegExp(a),!0}catch(a){return!1}}function bt(a){if(a instanceof Date)return a;if("string"==typeof a||"number"==typeof a){let b=new Date(a);if(!isNaN(b.valueOf()))return b;throw new bn(`${a} is in an invalid date format`)}throw new bn(`The date provided ${a} must be a string, number, or date object`)}class bu{getProperty(a){return this._memoryStorage[a]}setProperty(a,b){this._memoryStorage[a]=null!==b?b:void 0}constructor(){this._memoryStorage={}}}class bv extends aB{constructor(a,b={}){if(super(a,b),this._memoryStorage=new bu,this.options=b,this.options.featureFlagsPollingInterval="number"==typeof b.featureFlagsPollingInterval?Math.max(b.featureFlagsPollingInterval,100):3e4,b.personalApiKey){if(b.personalApiKey.includes("phc_"))throw Error('Your Personal API key is invalid. These keys are prefixed with "phx_" and can be created in PostHog project settings.');!1!==b.enableLocalEvaluation&&(this.featureFlagsPoller=new bp({pollingInterval:this.options.featureFlagsPollingInterval,personalApiKey:b.personalApiKey,projectApiKey:a,timeout:b.requestTimeout??1e4,host:this.host,fetch:b.fetch,onError:a=>{this._events.emit("error",a)},onLoad:a=>{this._events.emit("localEvaluationFlagsLoaded",a)},customHeaders:this.getCustomHeaders(),cacheProvider:b.flagDefinitionCacheProvider}))}this.errorTracking=new bj(this,b,this._logger),this.distinctIdHasSentFlagCalls={},this.maxCacheSize=b.maxCacheSize||5e4}getPersistedProperty(a){return this._memoryStorage.getProperty(a)}setPersistedProperty(a,b){return this._memoryStorage.setProperty(a,b)}fetch(a,b){return this.options.fetch?this.options.fetch(a,b):fetch(a,b)}getLibraryVersion(){return"5.14.1"}getCustomUserAgent(){return`${this.getLibraryId()}/${this.getLibraryVersion()}`}enable(){return super.optIn()}disable(){return super.optOut()}debug(a=!0){super.debug(a),this.featureFlagsPoller?.debug(a)}capture(a){"string"==typeof a&&this._logger.warn("Called capture() with a string as the first argument when an object was expected."),this.addPendingPromise(this.prepareEventMessage(a).then(({distinctId:a,event:b,properties:c,options:d})=>super.captureStateless(a,b,c,{timestamp:d.timestamp,disableGeoip:d.disableGeoip,uuid:d.uuid})).catch(a=>{a&&console.error(a)}))}async captureImmediate(a){return"string"==typeof a&&this._logger.warn("Called captureImmediate() with a string as the first argument when an object was expected."),this.addPendingPromise(this.prepareEventMessage(a).then(({distinctId:a,event:b,properties:c,options:d})=>super.captureStatelessImmediate(a,b,c,{timestamp:d.timestamp,disableGeoip:d.disableGeoip,uuid:d.uuid})).catch(a=>{a&&console.error(a)}))}identify({distinctId:a,properties:b,disableGeoip:c}){let d=b?.$set_once;delete b?.$set_once;let e=b?.$set||b;super.identifyStateless(a,{$set:e,$set_once:d},{disableGeoip:c})}async identifyImmediate({distinctId:a,properties:b,disableGeoip:c}){let d=b?.$set_once;delete b?.$set_once;let e=b?.$set||b;await super.identifyStatelessImmediate(a,{$set:e,$set_once:d},{disableGeoip:c})}alias(a){super.aliasStateless(a.alias,a.distinctId,void 0,{disableGeoip:a.disableGeoip})}async aliasImmediate(a){await super.aliasStatelessImmediate(a.alias,a.distinctId,void 0,{disableGeoip:a.disableGeoip})}isLocalEvaluationReady(){return this.featureFlagsPoller?.isLocalEvaluationReady()??!1}async waitForLocalEvaluationReady(a=3e4){return!!this.isLocalEvaluationReady()||void 0!==this.featureFlagsPoller&&new Promise(b=>{let c=setTimeout(()=>{d(),b(!1)},a),d=this._events.on("localEvaluationFlagsLoaded",a=>{clearTimeout(c),d(),b(a>0)})})}async getFeatureFlag(a,b,c){let d,e,{groups:f,disableGeoip:g}=c||{},{onlyEvaluateLocally:h,sendFeatureFlagEvents:i,personProperties:j,groupProperties:k}=c||{},m=this.addLocalPersonAndGroupProperties(b,f,j,k);j=m.allPersonProperties,k=m.allGroupProperties,void 0==h&&(h=!1),void 0==i&&(i=this.options.sendFeatureFlagEvent??!0);let n=await this.featureFlagsPoller?.getFeatureFlag(a,b,f,j,k),o=void 0!==n;if(!o&&!h){let c=await super.getFeatureFlagDetailStateless(a,b,f,j,k,g);if(void 0===c)return;n=l(e=c.response),d=c?.requestId}let p=`${a}_${n}`;return!i||b in this.distinctIdHasSentFlagCalls&&this.distinctIdHasSentFlagCalls[b].includes(p)||(Object.keys(this.distinctIdHasSentFlagCalls).length>=this.maxCacheSize&&(this.distinctIdHasSentFlagCalls={}),Array.isArray(this.distinctIdHasSentFlagCalls[b])?this.distinctIdHasSentFlagCalls[b].push(p):this.distinctIdHasSentFlagCalls[b]=[p],this.capture({distinctId:b,event:"$feature_flag_called",properties:{$feature_flag:a,$feature_flag_response:n,$feature_flag_id:e?.metadata?.id,$feature_flag_version:e?.metadata?.version,$feature_flag_reason:e?.reason?.description??e?.reason?.code,locally_evaluated:o,[`$feature/${a}`]:n,$feature_flag_request_id:d},groups:f,disableGeoip:g})),n}async getFeatureFlagPayload(a,b,c,d){let e,{groups:f,disableGeoip:g}=d||{},{onlyEvaluateLocally:h,personProperties:i,groupProperties:j}=d||{},k=this.addLocalPersonAndGroupProperties(b,f,i,j);if(i=k.allPersonProperties,j=k.allGroupProperties,void 0!==this.featureFlagsPoller){await this.featureFlagsPoller?.loadFeatureFlags();let d=this.featureFlagsPoller?.featureFlagsByKey[a];if(d)try{let a=await this.featureFlagsPoller?.computeFlagAndPayloadLocally(d,b,f,i,j,c);a&&(c=a.value,e=a.payload)}catch(a){if(a instanceof bo||a instanceof bn)this._logger?.info(`${a.name} when computing flag locally: ${d.key}: ${a.message}`);else throw a}}return void 0==h&&(h=!1),void 0!==e||h||(e=await super.getFeatureFlagPayloadStateless(a,b,f,i,j,g)),e}async getRemoteConfigPayload(a){if(!this.options.personalApiKey)throw Error("Personal API key is required for remote config payload decryption");let b=await this._requestRemoteConfigPayload(a);if(!b)return;let c=await b.json();if("string"==typeof c)try{return JSON.parse(c)}catch(a){}return c}async isFeatureEnabled(a,b,c){let d=await this.getFeatureFlag(a,b,c);if(void 0!==d)return!!d}async getAllFlags(a,b){return(await this.getAllFlagsAndPayloads(a,b)).featureFlags||{}}async getAllFlagsAndPayloads(a,b){let{groups:c,disableGeoip:d,flagKeys:e}=b||{},{onlyEvaluateLocally:f,personProperties:g,groupProperties:h}=b||{},i=this.addLocalPersonAndGroupProperties(a,c,g,h);g=i.allPersonProperties,h=i.allGroupProperties,void 0==f&&(f=!1);let j=await this.featureFlagsPoller?.getAllFlagsAndPayloads(a,c,g,h,e),k={},l={},m=!0;if(j&&(k=j.response,l=j.payloads,m=j.fallbackToFlags),m&&!f){let b=await super.getFeatureFlagsAndPayloadsStateless(a,c,g,h,d,e);k={...k,...b.flags||{}},l={...l,...b.payloads||{}}}return{featureFlags:k,featureFlagPayloads:l}}groupIdentify({groupType:a,groupKey:b,properties:c,distinctId:d,disableGeoip:e}){super.groupIdentifyStateless(a,b,c,{disableGeoip:e},d)}async reloadFeatureFlags(){await this.featureFlagsPoller?.loadFeatureFlags(!0)}async _shutdown(a){return this.featureFlagsPoller?.stopPoller(a),this.errorTracking.shutdown(),super._shutdown(a)}async _requestRemoteConfigPayload(a){if(!this.options.personalApiKey)return;let b=`${this.host}/api/projects/@current/feature_flags/${a}/remote_config?token=${encodeURIComponent(this.apiKey)}`,c={method:"GET",headers:{...this.getCustomHeaders(),"Content-Type":"application/json",Authorization:`Bearer ${this.options.personalApiKey}`}},d=null;if(this.options.requestTimeout&&"number"==typeof this.options.requestTimeout){let a=new AbortController;d=ap(()=>{a.abort()},this.options.requestTimeout),c.signal=a.signal}try{return await this.fetch(b,c)}catch(a){this._events.emit("error",a);return}finally{d&&clearTimeout(d)}}extractPropertiesFromEvent(a,b){if(!a)return{personProperties:{},groupProperties:{}};let c={},d={};for(let[e,f]of Object.entries(a))if($(f)&&b&&e in b){let a={};for(let[b,c]of Object.entries(f))a[String(b)]=String(c);d[String(e)]=a}else c[String(e)]=String(f);return{personProperties:c,groupProperties:d}}async getFeatureFlagsForEvent(a,b,c,d){let e=d?.personProperties||{},f=d?.groupProperties||{},g=d?.flagKeys;if(d?.onlyEvaluateLocally)if(!((this.featureFlagsPoller?.featureFlags?.length||0)>0))return{};else{let d={};for(let[a,c]of Object.entries(b||{}))d[a]=String(c);return await this.getAllFlags(a,{groups:d,personProperties:e,groupProperties:f,disableGeoip:c,onlyEvaluateLocally:!0,flagKeys:g})}if((this.featureFlagsPoller?.featureFlags?.length||0)>0){let d={};for(let[a,c]of Object.entries(b||{}))d[a]=String(c);return await this.getAllFlags(a,{groups:d,personProperties:e,groupProperties:f,disableGeoip:c,onlyEvaluateLocally:!0,flagKeys:g})}return(await super.getFeatureFlagsStateless(a,b,e,f,c)).flags}addLocalPersonAndGroupProperties(a,b,c,d){let e={distinct_id:a,...c||{}},f={};if(b)for(let a of Object.keys(b))f[a]={$group_key:b[a],...d?.[a]||{}};return{allPersonProperties:e,allGroupProperties:f}}captureException(a,b,c){let d=Error("PostHog syntheticException");this.addPendingPromise(bj.buildEventMessage(a,{syntheticException:d},b,c).then(a=>this.capture(a)))}async captureExceptionImmediate(a,b,c){let d=Error("PostHog syntheticException");this.addPendingPromise(bj.buildEventMessage(a,{syntheticException:d},b,c).then(a=>this.captureImmediate(a)))}async prepareEventMessage(a){let{distinctId:b,event:c,properties:d,groups:e,sendFeatureFlags:f,timestamp:g,disableGeoip:h,uuid:i}=a,j=this._runBeforeSend({distinctId:b,event:c,properties:d,groups:e,sendFeatureFlags:f,timestamp:g,disableGeoip:h,uuid:i});if(!j)return Promise.reject(null);let k=await Promise.resolve().then(async()=>f?await this.getFeatureFlagsForEvent(b,e,h,"object"==typeof f?f:void 0):{}).then(a=>{let b={};if(a)for(let[c,d]of Object.entries(a))b[`$feature/${c}`]=d;let c=Object.keys(a||{}).filter(b=>a?.[b]!==!1).sort();return c.length>0&&(b.$active_feature_flags=c),b}).catch(()=>({})).then(a=>({...a,...j.properties||{},$groups:j.groups||e}));return"$pageview"===j.event&&this.options.__preview_capture_bot_pageviews&&"string"==typeof k.$raw_user_agent&&t(k.$raw_user_agent,this.options.custom_blocked_useragents||[])&&(j.event="$bot_pageview",k.$browser_type="bot"),{distinctId:j.distinctId,event:j.event,properties:k,options:{timestamp:j.timestamp,disableGeoip:j.disableGeoip,uuid:j.uuid}}}_runBeforeSend(a){let b=this.options.before_send;if(!b)return a;let c=Array.isArray(b)?b:[b],d=a;for(let b of c){if(!(d=b(d)))return this._logger.info(`Event '${a.event}' was rejected in beforeSend function`),null;if(!d.properties||0===Object.keys(d.properties).length){let a=`Event '${d.event}' has no properties after beforeSend function, this is likely an error.`;this._logger.warn(a)}}return d}}var ba=a9;let bw="posthog-node";class bx{static #a=this.POSTHOG_ID_TAG="posthog_distinct_id";constructor(a,b,c,d,e){this.name=bw,this.name=bw,this.setupOnce=function(f,g){f(createEventProcessor(a,{organization:b,projectId:g()?.getClient()?.getDsn()?.projectId,prefix:c,severityAllowList:d,sendExceptionsToPostHog:e??!0}))}}}bj.errorPropertiesBuilder=new ba.ErrorPropertiesBuilder([new ba.EventCoercer,new ba.ErrorCoercer,new ba.ObjectCoercer,new ba.StringCoercer,new ba.PrimitiveCoercer],ba.createStackParser("node:javascript",ba.nodeStackLineParser),[(f=function(a=process.argv[1]?(0,j.dirname)(process.argv[1]):process.cwd(),b="\\"===j.sep){let c=b?k(a):a;return a=>{if(!a)return;let d=b?k(a):a,{dir:e,base:f,ext:g}=j.posix.parse(d);(".js"===g||".mjs"===g||".cjs"===g)&&(f=f.slice(0,-1*g.length));let h=decodeURIComponent(f);e||(e=".");let i=e.lastIndexOf("/node_modules");if(i>-1)return`${e.slice(i+14).replace(/\//g,".")}:${h}`;if(e.startsWith(c)){let a=e.slice(c.length+1).replace(/\//g,".");return a?`${a}:${h}`:h}return h}}(),async a=>{for(let b of a)b.module=f(b.filename);return a}),bf]);var by=a.i(13095);let bz=new class extends bv{getLibraryId(){return"posthog-node"}}("phc_UO0v3rJRQow9TQSBB2ecnwDA2Yvyw5lnUqtmaP7684S",{host:"https://eu.i.posthog.com",flushAt:1,flushInterval:0});async function bA(a){try{let b=await (0,i.headers)(),c=b.get("user-agent")||"unknown",d=b.get("x-forwarded-for"),e=b.get("x-real-ip"),f=d?.split(",")[0]||e||"anonymous",g=a.rawInput?.length||0,h=`anon_${f.replace(/\./g,"_")}`;return bz.capture({distinctId:h,event:"tool_used",properties:{tool_name:a.toolName,tool_category:a.toolCategory,input_type:a.inputType,input_size:g,processing_duration:a.processingDuration||null,user_agent:c,...a.metadata}}),await bz.flush(),{success:!0}}catch(a){return console.error("Failed to log tool usage:",a),{success:!1}}}(0,by.ensureServerEntryExports)([bA]),(0,h.registerServerReference)(bA,"40fe4c1ee107d4747170eecb3bccad9cd389e51646",null),a.s(["logToolUsage",()=>bA],44445)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__ad1e0216._.js.map